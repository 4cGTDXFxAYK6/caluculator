<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>履歴付き電卓</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<style>
  /* スタイルは元のものを完全に維持 */
  :root{ --bg:#000; --panel:rgba(255,255,255,0.08); --btn-dark:#333; --btn-gray:#a5a5a5; --btn-accent:#ff9f0a; --btn-accent2:#ffb347; --border:rgba(255,255,255,0.25); }
  html,body{ height:100%; margin:0; background:var(--bg); font-family:-apple-system, BlinkMacSystemFont, sans-serif; touch-action: manipulation; }
  body{ display:flex; align-items:center; justify-content:center; }
  .calculator{ width:100%; max-width:600px; margin:auto; padding:16px; padding-bottom:40px; display:flex; flex-direction:column; box-sizing:border-box; }
  .history{ background:var(--panel); backdrop-filter:blur(8px); color:#fff; height:300px; padding:12px 8px; border-radius:14px; overflow:auto; font-size:21px; line-height:1.0; margin-bottom:14px; }
  .history-line{ padding:6px 6px; border-radius:4px; display:flex; align-items:center; gap:10px; white-space:nowrap; overflow-x:auto; border-bottom:1px solid rgba(255,255,255,0.18); }
  .text{ flex:1; overflow:hidden; text-overflow:ellipsis; }
  .delete-btn{ flex-shrink:0; color:var(--btn-accent); font-size:26px; font-weight:700; cursor:pointer; padding:0 8px; }
  .total-box{ background:rgba(255,255,255,0.10); backdrop-filter:blur(6px); color:#fff; padding:12px 16px; border-radius:12px; font-size:26px; text-align:right; margin:0; }
  .keys{ display:grid; grid-template-columns:repeat(4, 1fr); width:100%; }
  button{ position:relative; overflow:hidden; height:56px; border:1px solid var(--border); font-size:24px; color:#fff; cursor:pointer; user-select:none; font-family:inherit; }
  button::after{ content:""; position:absolute; left:50%; top:50%; width:0; height:0; background:rgba(255,255,255,0.45); border-radius:50%; transform:translate(-50%,-50%); opacity:0; transition:width .35s, height .35s, opacity .35s; }
  button.pressed::after{ width:180%; height:180%; opacity:1; }
  .pressed{ background-color: rgba(255,255,255,0.65); box-shadow: inset 0 0 18px rgba(255,255,255,0.9); border-color: var(--btn-accent); color:#000; }
  .op, .equal { background: linear-gradient(var(--btn-accent2), var(--btn-accent)); font-size:30px; font-weight:700; border:2px solid rgba(255,255,255,0.35); color:#000; }
  .gray{ background:var(--btn-gray); color:#000; }
  .dark{ background:var(--btn-dark); }
  .zero{ grid-column:span 2; text-align:left; padding-left:28px; }
</style>
</head>
<body>

<div class="calculator">
  <div id="history" class="history"></div>
  <div id="totalBox" class="total-box">合計: 0</div>
  <div class="keys">
    <button class="gray" data-value="DEL">⌫</button>
    <button class="gray" data-value="AC">AC</button>
    <button class="gray" data-value="%">%</button>
    <button class="op" data-value="/">÷</button>

    <button class="dark" data-value="7">7</button>
    <button class="dark" data-value="8">8</button>
    <button class="dark" data-value="9">9</button>
    <button class="op" data-value="*">×</button>

    <button class="dark" data-value="4">4</button>
    <button class="dark" data-value="5">5</button>
    <button class="dark" data-value="6">6</button>
    <button class="op" data-value="-">−</button>

    <button class="dark" data-value="1">1</button>
    <button class="dark" data-value="2">2</button>
    <button class="dark" data-value="3">3</button>
    <button class="op" data-value="+">＋</button>

    <button class="dark zero" data-value="0">0</button>
    <button class="dark" data-value=".">.</button>
    <button class="equal" data-value="=">=</button>
  </div>
</div>

<script>
const historyPanel = document.getElementById("history");
const totalBox = document.getElementById("totalBox");
const keys = document.querySelector(".keys");

let current = "";
let previous = "";
let operator = null;
let justCalculated = false;

// 1. 安全な計算関数（evalの代替）
function runSafeCalc(a, b, op) {
  const n1 = parseFloat(a);
  const n2 = parseFloat(b);
  if (op === '+') return n1 + n2;
  if (op === '-') return n1 - n2;
  if (op === '*') return n1 * n2;
  if (op === '/') return n2 !== 0 ? n1 / n2 : 0;
  return n2;
}

// 2. フォーマット関数
function formatNumber(num){
  if(num === "" || num === null || num === undefined) return "";
  const n = Number(num);
  if(isNaN(n)) return num;
  const str = String(num);
  if(str.includes(".")){
    const [intPart, decPart] = str.split(".");
    return Number(intPart).toLocaleString("ja-JP") + "." + decPart;
  }
  return n.toLocaleString("ja-JP");
}

const toFull = s => s.replace(/\*/g,"×").replace(/\//g,"÷");

// 3. 合計計算（DOMを解析するオリジナルロジック）
function updateTotal(){
  let sum = 0;
  const lines = historyPanel.querySelectorAll('.history-line[data-type="history"]');
  lines.forEach(line=>{
    const text = line.querySelector(".text").textContent;
    const result = text.split("=").pop().trim().replace(/,/g,"");
    const num = Number(result);
    if(!isNaN(num)) sum += num;
  });
  totalBox.textContent = "合計: " + formatNumber(sum);
}

// 4. 入力行の更新（ここで「改行」を判定）
function updateInputLine(){
  let last = historyPanel.lastElementChild;
  // 一番下が history タイプなら新しい div を作る = これが改行の正体
  if(!last || last.dataset.type !== "input"){
    last = document.createElement("div");
    last.className = "history-line";
    last.dataset.type = "input";
    const text = document.createElement("span");
    text.className = "text";
    last.appendChild(text);
    historyPanel.appendChild(last);
  }
  const text = last.querySelector(".text");
  let expr = (previous && operator) 
    ? `${formatNumber(previous)} ${toFull(operator)} ${formatNumber(current)}`
    : formatNumber(current || "0");
  text.textContent = expr;
  historyPanel.scrollTop = historyPanel.scrollHeight;
}

// 5. 履歴の確定（現在の行を history タイプに変える）
function finalizeToHistory(expr, result, isSingleNumber = false){
  let line = historyPanel.lastElementChild;
  if(!line || line.dataset.type !== "input") return;

  line.dataset.type = "history";
  if(isSingleNumber){
    line.innerHTML = `<span class="text">${formatNumber(expr)}</span><span class="delete-btn">×</span>`;
  } else {
    // 数式を分解して再整形
    const parts = expr.split(/([+\-*/])/);
    const a = parts[0], op = parts[1], b = parts[2];
    line.innerHTML = `<span class="text">${formatNumber(a)} ${toFull(op)} ${formatNumber(b)} = ${formatNumber(result)}</span><span class="delete-btn">×</span>`;
  }
  updateTotal();
}

// 6. 計算実行
function calculate(){
  if(!operator && current !== ""){
    finalizeToHistory(current, current, true);
    current = ""; previous = ""; operator = null; justCalculated = true;
    updateInputLine(); // 次の行（改行）を作成
    return;
  }
  if(operator && previous !== "" && current !== ""){
    const result = runSafeCalc(previous, current, operator);
    const expr = previous + operator + current;
    finalizeToHistory(expr, String(result), false);
    current = ""; previous = ""; operator = null; justCalculated = true;
    updateInputLine(); // 次の行（改行）を作成
  }
}

// 7. 入力ハンドラ
function handleInput(value){
  if(justCalculated){
    if(!isNaN(value) || value === ".") current = "";
    justCalculated = false;
  }
  if(value === "AC"){
    current = ""; previous = ""; operator = null; justCalculated = false;
    historyPanel.innerHTML = "";
    updateInputLine(); updateTotal();
    return;
  }
  if(value === "DEL"){
    current = current.slice(0,-1);
    updateInputLine();
    return;
  }
  if(value === "%"){
    current = String(Number(current)/100);
    updateInputLine();
    return;
  }
  if(value === "."){
    if(current.includes(".")) return;
    if(current === "") current = "0";
    current += ".";
    updateInputLine();
    return;
  }
  if(["+","-","*","/"].includes(value)){
    operator = value;
    previous = current;
    current = "";
    updateInputLine();
    return;
  }
  if(value === "="){
    calculate();
    return;
  }
  current += value;
  updateInputLine();
}

// イベント設定
keys.addEventListener("click", e=>{
  const btn = e.target.closest("button");
  if(!btn) return;
  btn.classList.add("pressed");
  setTimeout(()=> btn.classList.remove("pressed"), 180);
  handleInput(btn.dataset.value);
});

historyPanel.addEventListener("click", e=>{
  if(e.target.classList.contains("delete-btn")){
    e.target.parentElement.remove();
    updateTotal();
  }
});

// 初期化
updateInputLine();
updateTotal();
</script>
</body>
</html>

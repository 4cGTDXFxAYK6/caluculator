<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Calculator Pro (Total Fixed)</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
  :root {
    --bg: #000;
    --panel: rgba(255, 255, 255, 0.08);
    --btn-dark: #333;
    --btn-gray: #a5a5a5;
    --btn-accent: #ff9f0a;
    --border: rgba(255, 255, 255, 0.25);
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; touch-action: none; }
  body { display: flex; align-items: center; justify-content: center; }
  .calculator { width: 100%; max-width: 600px; padding: 16px; display: flex; flex-direction: column; height: 100%; max-height: 900px; }
  .history { background: var(--panel); backdrop-filter: blur(10px); color: #fff; flex: 1; min-height: 200px; padding: 12px; border-radius: 16px; overflow-y: auto; font-size: 22px; margin-bottom: 12px; scrollbar-width: none; }
  .history::-webkit-scrollbar { display: none; }
  .history-line { padding: 10px 6px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between; animation: fadeIn 0.2s ease-out; }
  .text { flex: 1; white-space: nowrap; overflow-x: auto; scrollbar-width: none; }
  .delete-btn { color: var(--btn-accent); font-size: 26px; font-weight: bold; padding: 0 12px; cursor: pointer; }
  .total-box { background: rgba(255, 255, 255, 0.1); color: #fff; padding: 14px 18px; border-radius: 14px; font-size: 28px; text-align: right; margin-bottom: 12px; font-weight: 500; }
  .keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
  button { height: 70px; border: none; font-size: 26px; color: #fff; background: var(--btn-dark); cursor: pointer; outline: none; }
  button:active { filter: brightness(1.6); }
  .op, .equal { background: var(--btn-accent); color: #000; font-weight: 600; font-size: 30px; }
  .gray { background: var(--btn-gray); color: #000; }
  .zero { grid-column: span 2; text-align: left; padding-left: 35px; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
  @media (min-width: 768px) { button { height: 90px; font-size: 34px; } }
</style>
</head>
<body>

<div class="calculator">
  <div id="history" class="history"></div>
  <div id="totalBox" class="total-box">合計: 0</div>
  <div class="keys" id="keypad">
    <button class="gray" data-val="DEL">⌫</button>
    <button class="gray" data-val="AC">AC</button>
    <button class="gray" data-val="%">%</button>
    <button class="op" data-val="/">÷</button>
    <button data-val="7">7</button><button data-val="8">8</button><button data-val="9">9</button>
    <button class="op" data-val="*">×</button>
    <button data-val="4">4</button><button data-val="5">5</button><button data-val="6">6</button>
    <button class="op" data-val="-">−</button>
    <button data-val="1">1</button><button data-val="2">2</button><button data-val="3">3</button>
    <button class="op" data-val="+">＋</button>
    <button class="zero" data-val="0">0</button>
    <button data-val=".">.</button>
    <button class="equal" data-val="=">=</button>
  </div>
</div>

<script>
/**
 * State
 */
const state = {
  current: "",   // 現在入力中の数字
  previous: "",  // 演算前の数字（または中間結果）
  operator: null,
  isCalculated: false,

  reset() { this.current = ""; this.previous = ""; this.operator = null; this.isCalculated = false; },

  calculate() {
    const a = parseFloat(this.previous) || 0;
    const b = parseFloat(this.current) || 0;
    let res = 0;
    switch(this.operator) {
      case '+': res = a + b; break;
      case '-': res = a - b; break;
      case '*': res = a * b; break;
      case '/': res = b !== 0 ? a / b : 0; break;
      default: res = b;
    }
    return parseFloat(res.toPrecision(12));
  }
};

/**
 * UI
 */
const ui = {
  history: document.getElementById("history"),
  total: document.getElementById("totalBox"),

  format(num) {
    if (num === "-") return "-";
    if (num === "" || isNaN(num) || num === null) return num;
    const str = String(num);
    const [int, dec] = str.split(".");
    return Number(int).toLocaleString("ja-JP") + (dec !== undefined ? "." + dec : "");
  },

  toSymbol: s => s.replace(/\*/g,"×").replace(/\//g,"÷"),

  updateTotal() {
    let sum = 0;
    this.history.querySelectorAll('[data-type="history"]').forEach(line => {
      const resText = line.querySelector(".text").textContent.split("=").pop().replace(/,/g,"").trim();
      sum += parseFloat(resText) || 0;
    });
    this.total.textContent = `合計: ${this.format(parseFloat(sum.toPrecision(12)))}`;
  },

  renderInput() {
    let line = this.history.lastElementChild;
    // 履歴確定済みか、まだ一行もない場合は「入力用」の行を作る
    if (!line || line.dataset.type !== "input") {
      line = document.createElement("div");
      line.className = "history-line";
      line.dataset.type = "input";
      line.innerHTML = '<span class="text"></span>';
      this.history.appendChild(line);
    }
    
    // 表示ロジック: 演算子がある場合は「前回の結果 演算子 今回の入力」を表示
    const display = state.operator 
      ? `${this.format(state.previous)} ${this.toSymbol(state.operator)} ${this.format(state.current)}`
      : this.format(state.current || "0");
    
    line.querySelector(".text").textContent = display;
    this.history.scrollTop = this.history.scrollHeight;
  },

  finalize(result) {
    const line = this.history.lastElementChild;
    if (!line || line.dataset.type !== "input") return;
    
    // この行を履歴として確定させる（ここで初めて合計に反映される）
    line.dataset.type = "history";
    // 履歴には最終的な計算式「36」または「A op B = 36」を表示
    const finalDisplay = state.operator 
      ? `${this.format(state.previous)} ${this.toSymbol(state.operator)} ${this.format(state.current)} = ${this.format(result)}`
      : this.format(result);
    
    line.innerHTML = `<span class="text">${finalDisplay}</span><span class="delete-btn">×</span>`;
    this.updateTotal();
  }
};

/**
 * Controller
 */
function handleInput(val) {
  if (state.isCalculated && !isNaN(val)) state.current = "";
  state.isCalculated = false;

  if (val === "AC") {
    state.reset();
    ui.history.innerHTML = "";
    ui.updateTotal();
  } 
  else if (val === "DEL") {
    state.current = state.current.slice(0, -1);
  } 
  else if (val === "%") {
    if (state.current !== "" && state.current !== "-") {
      state.current = String(parseFloat(state.current) / 100);
    }
  }
  else if (val === "=") {
    if (state.current === "" || state.current === "-") {
      if (state.previous !== "") { // 3 + = のようなケース
        const res = parseFloat(state.previous);
        ui.finalize(res);
        state.reset();
        state.isCalculated = true;
      }
      return;
    }
    const res = state.calculate();
    ui.finalize(res);
    state.reset();
    state.isCalculated = true;
  } 
  else if (["+", "-", "*", "/"].includes(val)) {
    // 負の数からの開始
    if (val === "-" && state.current === "" && state.previous === "") {
      state.current = "-";
    } 
    else if (state.current !== "" && state.current !== "-") {
      if (state.operator) {
        // すでに演算子がある場合、中間結果を出して継続（履歴にはまだ書き出さない）
        state.previous = String(state.calculate());
      } else {
        state.previous = state.current;
      }
      state.operator = val;
      state.current = "";
    } 
    else if (state.previous !== "") {
      // 演算子の打ち直し
      state.operator = val;
    }
  } 
  else {
    if (val === "." && state.current.includes(".")) return;
    state.current += val;
  }
  
  ui.renderInput();
}

document.getElementById("keypad").addEventListener("pointerdown", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  e.preventDefault(); 
  handleInput(btn.dataset.val);
});

ui.history.addEventListener("pointerdown", e => {
  if (e.target.classList.contains("delete-btn")) {
    e.target.parentElement.remove();
    ui.updateTotal();
  }
});

ui.renderInput();
</script>
</body>
</html>

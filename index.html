<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>Process-Visible Calculator</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<style>
  :root {
    --bg: #000;
    --panel: rgba(255, 255, 255, 0.08);
    --btn-dark: #333;
    --btn-gray: #a5a5a5;
    --btn-accent: #ff9f0a;
    --border: rgba(255, 255, 255, 0.25);
  }
  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; overflow: hidden; touch-action: none; }
  body { display: flex; align-items: center; justify-content: center; }
  .calculator { width: 100%; max-width: 600px; padding: 16px; display: flex; flex-direction: column; height: 100%; }
  
  .history { background: var(--panel); backdrop-filter: blur(10px); color: #fff; flex: 1; padding: 12px; border-radius: 16px; overflow-y: auto; font-size: 22px; margin-bottom: 12px; scrollbar-width: none; }
  .history-line { padding: 10px 6px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); display: flex; align-items: center; justify-content: space-between; }
  .text { flex: 1; white-space: nowrap; overflow-x: auto; scrollbar-width: none; }
  .delete-btn { color: var(--btn-accent); font-size: 26px; font-weight: bold; padding: 0 12px; cursor: pointer; }
  
  .total-box { background: rgba(255, 255, 255, 0.1); color: #fff; padding: 14px 18px; border-radius: 14px; font-size: 28px; text-align: right; margin-bottom: 12px; font-weight: 500; }
  
  .keys { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: var(--border); border: 1px solid var(--border); }
  button { height: 75px; border: none; font-size: 26px; color: #fff; background: var(--btn-dark); cursor: pointer; outline: none; }
  button:active { filter: brightness(1.6); }
  .op, .equal { background: var(--btn-accent); color: #000; font-weight: 600; font-size: 30px; }
  .gray { background: var(--btn-gray); color: #000; }
  .zero { grid-column: span 2; text-align: left; padding-left: 35px; }

  @media (min-width: 768px) { button { height: 95px; font-size: 34px; } }
</style>
</head>
<body>

<div class="calculator">
  <div id="history" class="history"></div>
  <div id="totalBox" class="total-box">合計: 0</div>
  <div class="keys" id="keypad">
    <button class="gray" data-val="DEL">⌫</button>
    <button class="gray" data-val="AC">AC</button>
    <button class="gray" data-val="%">%</button>
    <button class="op" data-val="/">÷</button>
    <button data-val="7">7</button><button data-val="8">8</button><button data-val="9">9</button>
    <button class="op" data-val="*">×</button>
    <button data-val="4">4</button><button data-val="5">5</button><button data-val="6">6</button>
    <button class="op" data-val="-">−</button>
    <button data-val="1">1</button><button data-val="2">2</button><button data-val="3">3</button>
    <button class="op" data-val="+">＋</button>
    <button class="zero" data-val="0">0</button>
    <button data-val=".">.</button>
    <button class="equal" data-val="=">=</button>
  </div>
</div>

<script>
/**
 * State: 数式を配列で管理する (例: ["3", "+", "3", "×", "6"])
 */
const state = {
  formula: [], 
  current: "", 
  isCalculated: false,

  reset() { this.formula = []; this.current = ""; this.isCalculated = false; },

  // 左から右へ順番に計算するロジック
  execute() {
    let tokens = [...this.formula];
    if (this.current !== "" && this.current !== "-") tokens.push(this.current);
    if (tokens.length === 0) return 0;

    let res = parseFloat(tokens[0]);
    for (let i = 1; i < tokens.length; i += 2) {
      let op = tokens[i];
      let nextVal = parseFloat(tokens[i+1]);
      if (isNaN(nextVal)) continue;

      if (op === '+') res += nextVal;
      if (op === '-') res -= nextVal;
      if (op === '*') res *= nextVal;
      if (op === '/') res = nextVal !== 0 ? res / nextVal : 0;
    }
    return parseFloat(res.toPrecision(12));
  }
};

/**
 * UI
 */
const ui = {
  history: document.getElementById("history"),
  total: document.getElementById("totalBox"),

  format(num) {
    if (num === "-") return "-";
    if (num === "" || isNaN(num) || num === null) return num;
    const parts = String(num).split(".");
    parts[0] = Number(parts[0]).toLocaleString("ja-JP");
    return parts.join(".");
  },

  toSymbol: s => s.replace(/\*/g,"×").replace(/\//g,"÷"),

  updateTotal() {
    let sum = 0;
    this.history.querySelectorAll('[data-type="history"]').forEach(line => {
      const resText = line.querySelector(".text").textContent.split("=").pop().replace(/,/g,"").trim();
      sum += parseFloat(resText) || 0;
    });
    this.total.textContent = `合計: ${this.format(parseFloat(sum.toPrecision(12)))}`;
  },

  renderInput() {
    let line = this.history.lastElementChild;
    if (!line || line.dataset.type !== "input") {
      line = document.createElement("div");
      line.className = "history-line";
      line.dataset.type = "input";
      line.innerHTML = '<span class="text"></span>';
      this.history.appendChild(line);
    }
    
    // 配列内の数式を綺麗に並べる
    let displayStr = state.formula.map(item => 
      ["+","-","*","/"].includes(item) ? ` ${this.toSymbol(item)} ` : this.format(item)
    ).join("");
    
    displayStr += this.format(state.current);
    
    line.querySelector(".text").textContent = displayStr || "0";
    this.history.scrollTop = this.history.scrollHeight;
  },

  finalize(fullExpr, result) {
    const line = this.history.lastElementChild;
    if (!line) return;
    line.dataset.type = "history";
    line.innerHTML = `<span class="text">${fullExpr} = ${this.format(result)}</span><span class="delete-btn">×</span>`;
    this.updateTotal();
  }
};

/**
 * Controller
 */
function handleInput(val) {
  if (state.isCalculated && !isNaN(val)) {
    state.reset();
  }
  state.isCalculated = false;

  if (val === "AC") {
    state.reset();
    ui.history.innerHTML = "";
    ui.updateTotal();
  } 
  else if (val === "DEL") {
    if (state.current !== "") {
      state.current = state.current.slice(0, -1);
    } else if (state.formula.length > 0) {
      state.formula.pop(); // 演算子を消す
      state.current = state.formula.pop() || ""; // 数字を編集に戻す
    }
  } 
  else if (val === "%") {
    if (state.current !== "" && state.current !== "-") {
      state.current = String(parseFloat(state.current) / 100);
    }
  }
  else if (val === "=") {
    if (state.current === "" && state.formula.length === 0) return;
    const finalExpr = ui.history.lastElementChild.querySelector(".text").textContent;
    const res = state.execute();
    ui.finalize(finalExpr, res);
    state.reset();
    state.isCalculated = true;
  } 
  else if (["+", "-", "*", "/"].includes(val)) {
    // 最初のマイナス記号
    if (val === "-" && state.current === "" && state.formula.length === 0) {
      state.current = "-";
    } 
    else if (state.current !== "" && state.current !== "-") {
      state.formula.push(state.current);
      state.formula.push(val);
      state.current = "";
    } 
    else if (state.formula.length > 0) {
      // 演算子の打ち直し
      state.formula[state.formula.length - 1] = val;
    }
  } 
  else {
    if (val === "." && state.current.includes(".")) return;
    state.current += val;
  }
  
  ui.renderInput();
}

document.getElementById("keypad").addEventListener("pointerdown", e => {
  const btn = e.target.closest("button");
  if (!btn) return;
  e.preventDefault(); 
  handleInput(btn.dataset.val);
});

ui.history.addEventListener("pointerdown", e => {
  if (e.target.classList.contains("delete-btn")) {
    e.target.parentElement.remove();
    ui.updateTotal();
  }
});

ui.renderInput();
</script>
</body>
</html>

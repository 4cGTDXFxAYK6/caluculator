<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>履歴付き電卓</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
  :root{
    --bg:#000;
    --panel:rgba(255,255,255,0.08);
    --btn-dark:#333;
    --btn-gray:#a5a5a5;
    --btn-accent:#ff9f0a;
    --border:rgba(255,255,255,0.25);
    --row-b:rgba(255,255,255,0.18);
  }

  html,body{
    height:100%;
    margin:0;
    background:var(--bg);
    font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text", "SF Pro Display",
                 "Helvetica Neue", Arial, sans-serif;
    touch-action: manipulation;
  }

  body{
    display:flex;
    align-items:center;
    justify-content:center;
  }

  .calculator{
    width:100%;
    max-width:600px;
    margin:auto;
    padding:16px;
    padding-bottom:40px;
    display:flex;
    flex-direction:column;
    gap:0;
    box-sizing:border-box;
  }

  .history{
    background:var(--panel);
    backdrop-filter:blur(8px);
    color:#fff;
    height:300px;
    padding:12px 8px;
    border-radius:14px;
    overflow:auto;
    font-size:21px;
    line-height:1.0;
    margin-bottom:14px;
  }

  .history-line{
    padding:6px 6px;
    border-radius:4px;
    display:flex;
    align-items:center;
    gap:10px;
    white-space:nowrap;
    overflow-x:auto;
    scrollbar-width:none;
    border-bottom:1px solid rgba(255,255,255,0.18);
  }
  .history-line::-webkit-scrollbar{ display:none; }

  .text{
    flex:1;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .delete-btn{
    flex-shrink:0;
    color:var(--btn-accent);
    font-size:26px;
    font-weight:700;
    cursor:pointer;
    padding:0 8px;
  }

  .total-box{
    background:rgba(255,255,255,0.10);
    backdrop-filter:blur(6px);
    color:#fff;
    padding:12px 16px;
    border-radius:12px;
    font-size:26px;
    text-align:right;
    margin:0;
  }

  .keys{
    display:grid;
    grid-template-columns:repeat(4, 1fr);
    gap:0;
    width:100%;
    margin:0;
  }

  button{
    position:relative;
    overflow:hidden;

    height:56px;
    border-radius:0;
    border:1px solid var(--border);

    font-size:24px;
    line-height:1;

    color:#fff;
    cursor:pointer;
    user-select:none;
    font-family:inherit;

    transition:
      background-color 0.05s ease-out,
      box-shadow 0.05s ease-out,
      border-color 0.05s ease-out,
      color 0.05s ease-out;
  }

  /* ▼ 軽量版 ripple（CSSのみ） */
  button::after{
    content:"";
    position:absolute;
    left:50%;
    top:50%;
    width:0;
    height:0;
    background:rgba(255,255,255,0.45);
    border-radius:50%;
    transform:translate(-50%,-50%);
    opacity:0;
    transition:width .35s ease-out, height .35s ease-out, opacity .35s ease-out;
  }

  button.pressed::after{
    width:180%;
    height:180%;
    opacity:1;
  }

  /* transform を完全排除した押下エフェクト */
  .pressed{
    background-color: rgba(255,255,255,0.65);
    box-shadow:
      inset 0 0 18px rgba(255,255,255,0.9),
      0 0 10px rgba(255,255,255,0.6);
    border-color: var(--btn-accent);
    color:#000;
  }

  .gray{ background:var(--btn-gray); color:#000; }
  .dark{ background:var(--btn-dark); }
  .orange{ background:var(--btn-accent); }

  .zero{
    grid-column:span 2;
    text-align:left;
    padding-left:28px;
  }

  /* transform を使わず実寸で拡大 */
  @media (min-width:768px) and (orientation:portrait){
    .calculator{ max-width:760px; }
    button{ height:74px; font-size:30px; }
    .history{ font-size:26px; }
  }

  @media (min-width:1024px) and (orientation:landscape){
    .calculator{ max-width:900px; }
    button{ height:70px; font-size:28px; }
    .history{ font-size:24px; }
  }
</style>
</head>
<body>

<div class="calculator">

  <div id="history" class="history"></div>

  <div id="totalBox" class="total-box">合計: 0</div>

  <div class="keys">
    <button class="gray" data-value="DEL">⌫</button>
    <button class="gray" data-value="AC">AC</button>
    <button class="gray" data-value="%">%</button>
    <button class="orange" data-value="/">÷</button>

    <button class="dark" data-value="7">7</button>
    <button class="dark" data-value="8">8</button>
    <button class="dark" data-value="9">9</button>
    <button class="orange" data-value="*">×</button>

    <button class="dark" data-value="4">4</button>
    <button class="dark" data-value="5">5</button>
    <button class="dark" data-value="6">6</button>
    <button class="orange" data-value="-">-</button>

    <button class="dark" data-value="1">1</button>
    <button class="dark" data-value="2">2</button>
    <button class="dark" data-value="3">3</button>
    <button class="orange" data-value="+">+</button>

    <button class="dark zero" data-value="0">0</button>
    <button class="dark" data-value=".">.</button>
    <button class="orange" data-value="=">=</button>
  </div>
</div>

<script>
/* ▼ 計算ロジック（小数点保持版） */

const historyPanel = document.getElementById("history");
const totalBox = document.getElementById("totalBox");
const keys = document.querySelector(".keys");

let current = "";
let previous = "";
let operator = null;
let justCalculated = false;

/* ▼ 小数点以下を丸めず保持する formatNumber */
function formatNumber(num){
  if(num === "" || num === null || num === undefined) return "";

  if(isNaN(Number(num))) return num;

  const str = String(num);

  if(str.includes(".")){
    const [intPart, decPart] = str.split(".");
    const intFormatted = Number(intPart).toLocaleString("ja-JP");
    return intFormatted + "." + decPart;
  }

  return Number(str).toLocaleString("ja-JP");
}

/* ▼ 軽量 ripple */
keys.addEventListener("click", e=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  btn.classList.add("pressed");
  setTimeout(()=> btn.classList.remove("pressed"), 180);

  handleInput(btn.dataset.value);
});

/* ▼ 計算ロジック */
const toFull = s =>
  s.replace(/\*/g,"×")
   .replace(/\//g,"÷");

function updateTotal(){
  let sum = 0;
  const lines = historyPanel.querySelectorAll('.history-line[data-type="history"]');

  lines.forEach(line=>{
    const text = line.querySelector(".text").textContent;
    const result = text.split("=").pop().trim().replace(/,/g,"");
    const num = Number(result);
    if(!isNaN(num)) sum += num;
  });

  totalBox.textContent = "合計: " + formatNumber(sum);
}

function updateInputLine(){
  let last = historyPanel.lastElementChild;

  if(!last || last.dataset.type !== "input"){
    last = document.createElement("div");
    last.className = "history-line";
    last.dataset.type = "input";

    const text = document.createElement("span");
    text.className = "text";
    last.appendChild(text);

    historyPanel.appendChild(last);
  }

  const text = last.querySelector(".text");

  let expr = "";
  if(previous && operator){
    expr = `${formatNumber(previous)} ${toFull(operator)} ${formatNumber(current)}`;
  } else {
    expr = formatNumber(current || "0");
  }

  text.textContent = expr;
  historyPanel.scrollTop = historyPanel.scrollHeight;
}

function finalizeToHistory(expr, result, isSingleNumber = false){
  let line = historyPanel.lastElementChild;

  if(!line || line.dataset.type !== "input"){
    line = document.createElement("div");
    line.className = "history-line";
    historyPanel.appendChild(line);
  }

  line.dataset.type = "history";

  if(isSingleNumber){
    line.innerHTML = `
      <span class="text">${formatNumber(expr)}</span>
      <span class="delete-btn">×</span>
    `;
  } else {
    const [a,op,b] = expr.split(/([+\-*/])/);
    line.innerHTML = `
      <span class="text">${formatNumber(a)} ${toFull(op)} ${formatNumber(b)} = ${formatNumber(result)}</span>
      <span class="delete-btn">×</span>
    `;
  }

  historyPanel.scrollTop = historyPanel.scrollHeight;
  updateTotal();
}

function resetAll(){
  current = "";
  previous = "";
  operator = null;
  justCalculated = false;
  historyPanel.innerHTML = "";
  updateInputLine();
  updateTotal();
}

function calculate(){
  if(!operator && current !== ""){
    finalizeToHistory(current, current, true);
    current = "";
    previous = "";
    operator = null;
    justCalculated = true;
    updateInputLine();
    return;
  }

  if(operator && previous !== "" && current !== ""){
    const expr = previous + operator + current;
    const result = String(eval(expr));

    finalizeToHistory(expr, result, false);

    current = "";
    previous = "";
    operator = null;
    justCalculated = true;

    updateInputLine();
  }
}

function handleInput(value){
  if(justCalculated){
    if(!isNaN(value) || value === ".") current = "";
    justCalculated = false;
  }

  if(value === "AC"){
    resetAll();
    return;
  }

  if(value === "DEL"){
    current = current.slice(0,-1);
    updateInputLine();
    return;
  }

  if(value === "%"){
    current = String(Number(current)/100);
    updateInputLine();
    return;
  }

  if(value === "."){
    if(current.includes(".")) return;
    if(current === "") current = "0";
    current += ".";
    updateInputLine();
    return;
  }

  if(["+","-","*","/"].includes(value)){
    operator = value;
    previous = current;
    current = "";
    updateInputLine();
    return;
  }

  if(value === "="){
    calculate();
    return;
  }

  current += value;
  updateInputLine();
}

historyPanel.addEventListener("click", e=>{
  if(e.target.classList.contains("delete-btn")){
    e.target.parentElement.remove();
    updateTotal();
  }
});

updateInputLine();
updateTotal();

/* Service Worker */
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js');
  navigator.serviceWorker.addEventListener('controllerchange', () => {
    window.location.reload();
  });
}
</script>

</body>
</html>

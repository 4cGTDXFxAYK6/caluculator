<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>履歴付き電卓</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<style>
  :root {
    --bg: #000;
    --panel: rgba(255,255,255,0.06);
    --btn-dark: #333;
    --btn-gray: #a5a5a5;
    --btn-accent: #ff9f0a;
    --neg: #ff3b30;
    --row-b: rgba(255,255,255,0.22);
  }
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Arial, sans-serif;
    touch-action: manipulation;
  }
  body {
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .calculator {
    width: 100%;
    max-width: 600px;
    margin: auto;
    padding: 16px;
    padding-bottom: 40px;
    display: flex;
    flex-direction: column;
    gap: 14px;
    box-sizing: border-box;
  }
  .history {
    background: var(--panel);
    backdrop-filter: blur(8px);
    color: #eee;
    height: 240px;
    padding: 12px;
    border-radius: 14px;
    overflow: auto;
    font-size: 22px;
    line-height: 1.0;
  }
  .history-line {
    padding: 4px 6px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    gap: 10px;
    white-space: nowrap;
    overflow-x: auto;
    scrollbar-width: none;
    border-bottom: 1px solid rgba(255,255,255,0.18);
  }
  .history-line::-webkit-scrollbar { display: none; }
  .history-line:nth-child(even) { background: var(--row-b); }
  .text {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .delete-btn {
    flex-shrink: 0;
    color: var(--btn-accent);
    font-size: 26px;
    font-weight: 700;
    cursor: pointer;
    padding: 0 8px;
  }
  .total-box {
    background: rgba(255,255,255,0.10);
    backdrop-filter: blur(6px);
    color: #fff;
    padding: 12px 16px;
    border-radius: 12px;
    font-size: 26px;
    text-align: right;
  }
  .keys {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 0;
    width: 100%;
  }
  button {
    position: relative;
    overflow: hidden;
    height: 56px;
    min-height: 48px;
    max-height: 64px;
    border-radius: 0;
    border: none;
    font-size: 24px;
    line-height: 1;
    color: #fff;
    cursor: pointer;
    user-select: none;
    font-family: inherit;
    transition: transform 0.08s, filter 0.08s;
  }
  button:active {
    transform: scale(.88);
    filter: brightness(1.45);
  }
  .gray { background: var(--btn-gray); color: #000; }
  .dark { background: var(--btn-dark); }
  .orange { background: var(--btn-accent); }
  .zero {
    grid-column: span 2;
    text-align: left;
    padding-left: 28px;
  }
</style>
</head>
<body>
<div class="calculator">
  <div id="history" class="history"></div>
  <div id="totalBox" class="total-box">合計: 0</div>
  <div class="keys">
    <button class="gray" data-value="DEL">⌫</button>
    <button class="gray" data-value="AC">AC</button>
    <button class="gray" data-value="%">%</button>
    <button class="orange" data-value="/">÷</button>
    <button class="dark" data-value="7">7</button>
    <button class="dark" data-value="8">8</button>
    <button class="dark" data-value="9">9</button>
    <button class="orange" data-value="*">×</button>
    <button class="dark" data-value="4">4</button>
    <button class="dark" data-value="5">5</button>
    <button class="dark" data-value="6">6</button>
    <button class="orange" data-value="-">-</button>
    <button class="dark" data-value="1">1</button>
    <button class="dark" data-value="2">2</button>
    <button class="dark" data-value="3">3</button>
    <button class="orange" data-value="+">+</button>
    <button class="dark zero" data-value="0">0</button>
    <button class="dark" data-value=".">.</button>
    <button class="orange" data-value="=">=</button>
  </div>
</div>
<script>
const historyPanel = document.getElementById("history");
const totalBox = document.getElementById("totalBox");
const keys = document.querySelector(".keys");
let current = "";
let previous = "";
let operator = null;
let justCalculated = false;
const toFull = s => s.replace(/\*/g,"×").replace(/\//g,"÷");
function updateTotal(){
  let sum = 0;
  const lines = historyPanel.querySelectorAll('.history-line[data-type="history"]');
  lines.forEach(line=>{
    const text = line.querySelector(".text").textContent;
    const result = text.split("=").pop().trim();
    const num = Number(result);
    if(!isNaN(num)) sum += num;
  });
  totalBox.textContent = "合計: " + sum;
}
function updateInputLine(){
  let last = historyPanel.lastElementChild;
  if(!last || last.dataset.type !== "input"){
    last = document.createElement("div");
    last.className = "history-line";
    last.dataset.type = "input";
    const text = document.createElement("span");
    text.className = "text";
    last.appendChild(text);
    historyPanel.appendChild(last);
  }
  const text = last.querySelector(".text");
  let expr = "";
  if(previous && operator) expr = toFull(previous + " " + operator + " " + current);
  else expr = toFull(current || "0");
  text.textContent = expr;
  historyPanel.scrollTop = historyPanel.scrollHeight;
}
function finalizeToHistory(expr, result, isSingleNumber = false){
  let line = historyPanel.lastElementChild;
  if(!line || line.dataset.type !== "input"){
    line = document.createElement("div");
    line.className = "history-line";
    historyPanel.appendChild(line);
  }
  line.dataset.type = "history";
  if(isSingleNumber){
    line.innerHTML = `<span class="text">${expr}</span><span class="delete-btn">×</span>`;
  } else {
    line.innerHTML = `<span class="text">${toFull(expr)} = ${result}</span><span class="delete-btn">×</span>`;
  }
  if(Number(result) < 0) line.querySelector(".text").classList.add("negative");
  historyPanel.scrollTop = historyPanel.scrollHeight;
  updateTotal();
}
function resetAll(){
  current = "";
  previous = "";
  operator = null;
  justCalculated = false;
  historyPanel.innerHTML = "";
  updateInputLine();
  updateTotal();
}
function calculate(){
  if(!operator && current !== ""){
    finalizeToHistory(current, current, true);
    current = "";
    previous = "";
    operator = null;
    justCalculated = true;
    updateInputLine();
